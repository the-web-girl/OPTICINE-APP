<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ma Bibliothèque – Films & Séries</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f5f5f5; }
    header { background:#333; color:white; padding:1rem; text-align:center; }
    main { max-width:800px; margin:2rem auto; padding:1rem; background:white; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
    form input, form select, form button { display:block; margin:0.5rem 0; padding:0.5rem; width:100%; }
    .autocomplete-suggestions { position: absolute; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; width:calc(100% - 1rem); z-index:1000; }
    .autocomplete-suggestion { padding:6px 10px; cursor:pointer; }
    .autocomplete-suggestion:hover { background:#f0f0f0; }
    .item { display:flex; align-items:center; gap:1rem; margin:1rem 0; padding:0.5rem; border:1px solid #ddd; border-radius:6px; }
    .item img { width:60px; border-radius:4px; }
    .owned { font-weight:bold; color:green; }
  </style>
</head>
<body>
  <header>

  </header>

  <main>

  </main>

  <script type="module">
    // === Configuration Firebase ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "TA_CLE_FIREBASE_ICI",
      authDomain: "TON_PROJET.firebaseapp.com",
      projectId: "TON_PROJET",
      storageBucket: "TON_PROJET.appspot.com",
      messagingSenderId: "XXX",
      appId: "XXX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // === TMDB API ===
    const TMDB_KEY = "TA_CLE_TMDB_ICI";  // Remplace par ta clé TMDB
    const TMDB_BASE = "https://api.themoviedb.org/3";

    async function fetchPoster(title, type = "film") {
      try {
        const searchType = type === "serie" ? "tv" : "movie";
        const url = `${TMDB_BASE}/search/${searchType}?api_key=${TMDB_KEY}&query=${encodeURIComponent(title)}&language=fr-FR`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.results?.length) return null;
        const best = data.results[0];
        if (best.poster_path) {
          return "https://image.tmdb.org/t/p/w500" + best.poster_path;
        }
      } catch (e) {
        console.warn("TMDB fetch error", e);
      }
      return null;
    }

    async function fetchSuggestions(query, type = "film") {
      try {
        const searchType = type === "serie" ? "tv" : "movie";
        const url = `${TMDB_BASE}/search/${searchType}?api_key=${TMDB_KEY}&query=${encodeURIComponent(query)}&language=fr-FR`;
        const res = await fetch(url);
        const data = await res.json();
        return data.results || [];
      } catch (e) {
        console.warn("TMDB suggestions error", e);
        return [];
      }
    }

    // === DOM Elements ===
    const titleEl = document.getElementById('title');
    const autocompleteEl = document.getElementById('autocomplete');
    const typeEl = document.getElementById('type');
    const posterEl = document.getElementById('poster');
    const yearEl = document.getElementById('year');
    const form = document.getElementById('addForm');
    const listEl = document.getElementById('list');
    const ownedEl = document.getElementById('owned');
    const f4kEl = document.getElementById('format4k');
    const fbrEl = document.getElementById('formatbr');
    const sagaEl = document.getElementById('saga');
    const seriesIdEl = document.getElementById('seriesId');
    const seasonNumberEl = document.getElementById('seasonNumber');
    const spinOffOfEl = document.getElementById('spinOffOf');

    let state = { items: [] };

    // === Auto-complétion ===
    let suggestionTimeout;
    titleEl.addEventListener('input', () => {
      clearTimeout(suggestionTimeout);
      const query = titleEl.value.trim();
      if (query.length < 2) {
        autocompleteEl.style.display = 'none';
        return;
      }
      suggestionTimeout = setTimeout(async () => {
        const results = await fetchSuggestions(query, typeEl.value);
        autocompleteEl.innerHTML = '';
        if (!results.length) {
          autocompleteEl.style.display = 'none';
          return;
        }
        results.slice(0, 6).forEach(r => {
          const div = document.createElement('div');
          div.className = 'autocomplete-suggestion';
          div.textContent = typeEl.value === 'serie' ? r.name : r.title;
          div.addEventListener('click', () => {
            titleEl.value = typeEl.value === 'serie' ? r.name : r.title;
            if (r.release_date || r.first_air_date) yearEl.value = (r.release_date || r.first_air_date).split('-')[0];
            if (r.poster_path) posterEl.value = "https://image.tmdb.org/t/p/w500" + r.poster_path;
            autocompleteEl.style.display = 'none';
          });
          autocompleteEl.appendChild(div);
        });
        autocompleteEl.style.display = 'block';
      }, 300);
    });

    document.addEventListener('click', (e) => {
      if (!autocompleteEl.contains(e.target) && e.target !== titleEl) {
        autocompleteEl.style.display = 'none';
      }
    });

    // === Sauvegarde locale ===
    function saveToLocal() {
      localStorage.setItem('bibliotheque', JSON.stringify(state.items));
    }
    function loadFromLocal() {
      const raw = localStorage.getItem('bibliotheque');
      if (raw) state.items = JSON.parse(raw);
    }

    // === Rendu ===
    function render() {
      listEl.innerHTML = '';
      state.items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <img src=\"${item.posterUrl || ''}\" alt=\"cover\">
          <div>
            <div><strong>${item.title}</strong> (${item.year || ''}) [${item.type}]</div>
            <div>${item.saga || ''}</div>
            <div>${item.owned ? '<span class=\"owned\">Possédé</span>' : 'Non possédé'}</div>
            <div>Formats: ${item.formats.join(', ')}</div>
          </div>
        `;
        listEl.appendChild(div);
      });
    }

    // === Soumission ===
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      let item = {
        title: titleEl.value.trim(),
        year: yearEl.value.trim(),
        posterUrl: posterEl.value.trim(),
        type: typeEl.value,
        saga: sagaEl.value.trim(),
        seriesId: seriesIdEl.value.trim(),
        seasonNumber: seasonNumberEl.value.trim(),
        spinOffOf: spinOffOfEl.value.trim(),
        owned: ownedEl.checked,
        formats: [ ...(f4kEl.checked ? ['4K'] : []), ...(fbrEl.checked ? ['Blu-ray'] : []) ],
        createdAt: Date.now(),
      };
      if (!item.title) return alert('Titre requis');

      if (!item.posterUrl) {
        const autoPoster = await fetchPoster(item.title, item.type);
        if (autoPoster) item.posterUrl = autoPoster;
      }

      state.items.unshift(item);
      saveToLocal();
      render();

      try {
        await addDoc(collection(db, \"items\"), { ...item, createdAt: serverTimestamp() });
      } catch (e) {
        console.warn('Firestore add error', e);
      }

      form.reset();
    });

    // === Init ===
    loadFromLocal();
    render();
  </script>
</body>
</html>
