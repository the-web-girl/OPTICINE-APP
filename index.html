<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üé¨ Biblioth√®que Films & S√©ries blablabla</title>
  <meta name="description" content="Collection partag√©e multi-utilisateurs ‚Ä¢ Recherche TMDB automatique ‚Ä¢ Formats DVD/Blu-ray/4K ‚Ä¢ √âditions Simple/Steelbook ‚Ä¢ Synchronisation temps r√©el via Firebase">
  <meta name="color-scheme" content="dark light">

  <link rel="stylesheet" href="style.css">

  <style>
        /* Design system bas√© sur index.css */
    :root {
      /* Cin√©ma dark theme - noir, blanc, rouge, gris */
      --background: 220 13% 6%;
      --foreground: 0 0% 98%;
      --card: 220 13% 8%;
      --card-foreground: 0 0% 98%;
      --popover: 220 13% 8%;
      --popover-foreground: 0 0% 98%;
      --primary: 0 84% 60%;
      --primary-foreground: 0 0% 98%;
      --secondary: 220 9% 46%;
      --secondary-foreground: 0 0% 98%;
      --muted: 220 13% 16%;
      --muted-foreground: 220 9% 70%;
      --accent: 0 84% 60%;
      --accent-foreground: 0 0% 98%;
      --destructive: 0 84% 60%;
      --destructive-foreground: 0 0% 98%;
      --border: 220 13% 20%;
      --input: 220 13% 16%;
      --ring: 0 84% 60%;
      --radius: 0.75rem;

      /* Custom cinema theme colors */
      --cinema-bg: 220 13% 4%;
      --cinema-panel: 220 13% 8%;
      --cinema-red: 0 84% 60%;
      --cinema-gray: 220 9% 46%;
      --cinema-white: 0 0% 98%;
      --cinema-black: 220 13% 6%;
      --cinema-border: 220 13% 20%;
      
      /* Gradients */
      --gradient-cinema: linear-gradient(135deg, hsl(var(--cinema-bg)), hsl(220 13% 2%));
      --gradient-panel: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      --gradient-red: linear-gradient(90deg, hsl(var(--cinema-red)), hsl(0 62% 45%));
      
      /* Shadows */
      --shadow-elegant: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
      --shadow-red: 0 0 20px hsla(var(--cinema-red), 0.3);
      
      /* Animations */
      --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, Cantarell, 'Noto Sans', sans-serif;
      background: var(--gradient-cinema);
      color: hsl(var(--foreground));
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(12px);
      background: hsl(var(--background) / 0.8);
      border-bottom: 1px solid hsl(var(--border));
      padding: 1.5rem 0;
    }

    .header-content {
      text-align: center;
    }

    h1 {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: hsl(var(--foreground));
    }

    .subtitle {
      color: hsl(var(--muted-foreground));
      font-size: 0.875rem;
      max-width: 64rem;
      margin: 0 auto;
    }

    /* Panel */
    .panel {
      background: var(--gradient-panel);
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      box-shadow: var(--shadow-elegant);
      padding: 1.5rem;
      margin: 2rem 0;
    }

    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 1rem;
      align-items: end;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .field.col-3 { grid-column: span 3; }
    .field.col-6 { grid-column: span 6; }
    .field.col-12 { grid-column: span 12; }

    label {
      font-size: 0.75rem;
      font-weight: 500;
      color: hsl(var(--muted-foreground));
    }

    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid hsl(var(--border));
      background: hsl(var(--input));
      color: hsl(var(--foreground));
      font-size: 0.875rem;
      transition: var(--transition-smooth);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: hsl(var(--ring));
      box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: var(--transition-smooth);
      text-decoration: none;
    }

    .btn-primary {
      background: var(--gradient-red);
      color: hsl(var(--primary-foreground));
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-red);
    }

    .btn-secondary {
      background: hsl(var(--secondary));
      color: hsl(var(--secondary-foreground));
      border: 1px solid hsl(var(--border));
    }

    .btn-secondary:hover {
      background: hsl(var(--secondary) / 0.8);
    }

    .btn-destructive {
      background: hsl(var(--destructive));
      color: hsl(var(--destructive-foreground));
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid hsl(var(--border));
      color: hsl(var(--foreground));
    }

    .btn-ghost:hover {
      background: hsl(var(--accent) / 0.1);
    }

    /* Chips */
    .chips {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 9999px;
      border: 1px solid hsl(var(--border));
      background: hsl(var(--card) / 0.5);
      font-size: 0.75rem;
      cursor: pointer;
      transition: var(--transition-smooth);
    }

    .chip:hover {
      background: hsl(var(--card));
    }

    .chip input[type="checkbox"] {
      width: auto;
      margin: 0;
      accent-color: hsl(var(--accent));
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      margin: 2rem 0;
    }

    .toolbar .search-input {
      flex: 1;
      min-width: 200px;
    }

    /* Lists */
    .section {
      margin: 3rem 0;
    }

    .section h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: hsl(var(--foreground));
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      border: 2px solid green;
    }

    /* Cards */
    .card {
      /* background: var(--gradient-panel); */
      background-color: lightcoral;
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      overflow: hidden;
      transition: var(--transition-smooth);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-elegant);
    }

    .poster {
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      background: hsl(var(--muted));
    }

    .card-content {
      padding: 1rem;
    }

    .card-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: hsl(var(--foreground));
    }

    .card-meta {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
      margin-bottom: 0.75rem;
    }

    .badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .badge {
      font-size: 0.625rem;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      border: 1px solid hsl(var(--border));
      background: hsl(var(--muted) / 0.3);
      color: hsl(var(--muted-foreground));
    }

    .card-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .card-actions-left {
      display: flex;
      flex-wrap: wrap;
      flex-direction: column;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }

    /* Autocomplete */
    .ac-wrapper {
      position: relative;
    }

    .ac-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: hsl(var(--popover));
      border: 1px solid hsl(var(--border));
      border-radius: 0.5rem;
      margin-top: 0.25rem;
      max-height: 320px;
      overflow-y: auto;
      z-index: 50;
      display: none;
    }

    .ac-item {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem;
      cursor: pointer;
      align-items: center;
    }

    .ac-item:hover {
      background: hsl(var(--accent) / 0.1);
    }

    .ac-item img {
      width: 40px;
      height: 60px;
      object-fit: cover;
      border-radius: 0.25rem;
      background: hsl(var(--muted));
    }

    .ac-item-info {
      display: flex;
      flex-direction: column;
    }

    .ac-item-title {
      font-weight: 600;
      color: hsl(var(--foreground));
    }

    .ac-item-year {
      font-size: 0.75rem;
      color: hsl(var(--muted-foreground));
    }

    /* Footer */
    footer {
      border-top: 1px solid hsl(var(--border));
      background: hsl(var(--card) / 0.5);
      padding: 2rem 0;
      margin-top: 4rem;
      text-align: center;
    }

    .footer-text {
      font-size: 0.875rem;
      color: hsl(var(--muted-foreground));
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 3rem 0;
      color: hsl(var(--muted-foreground));
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: hsl(var(--card));
      border: 1px solid hsl(var(--border));
      border-radius: var(--radius);
      padding: 1rem;
      max-width: 300px;
      z-index: 100;
      transform: translateX(100%);
      opacity: 0;
      transition: var(--transition-smooth);
    }

    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }

    .toast.success {
      border-color: hsl(120 84% 60%);
    }

    .toast.error {
      border-color: hsl(var(--destructive));
    }

    /* Responsive */
    @media (max-width: 768px) {
      .field.col-3 { grid-column: span 6; }
      .field.col-6 { grid-column: span 12; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar .search-input { min-width: auto; }
      .grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 480px) {
      .field.col-3, .field.col-6 { grid-column: span 12; }
      .card-actions { flex-direction: column; align-items: stretch; }
      .card-actions-left { justify-content: center; }
    }
    
    /* Hidden */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>

</head>

<body>
  <header>
    <div class="container">
      <div class="header-content">
        <h1>üé¨ Biblioth√®que Films & S√©ries</h1>
        <p class="subtitle">
          Collection partag√©e multi-utilisateurs ‚Ä¢ Recherche TMDB automatique ‚Ä¢ 
          Formats DVD/Blu-ray/4K ‚Ä¢ √âditions Simple/Steelbook ‚Ä¢ 
          Synchronisation temps r√©el via Firebase Firestore.
        </p>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Formulaire d'ajout -->
    <section class="panel">
      <h2 class="sr-only">Ajouter un film ou une s√©rie</h2>
      <form id="addForm">
        <div class="form-grid">
          <div class="field col-3">
            <label for="type">Type</label>
            <select id="type">
              <option value="film">Film</option>
              <option value="serie">S√©rie</option>
            </select>
          </div>
          
          <div class="field col-6 ac-wrapper">
            <label for="title">Titre (recherche automatique)</label>
            <input id="title" type="text" placeholder="Ex: Star Wars" autocomplete="off" />
            <div id="ac-list" class="ac-list"></div>
          </div>
          
          <div class="field col-3">
            <label for="year">Ann√©e</label>
            <input id="year" type="text" placeholder="Ex: 1977" />
          </div>
          
          <div class="field col-6">
            <label for="posterUrl">URL Jaquette (auto-remplie)</label>
            <input id="posterUrl" type="url" placeholder="https://..." />
          </div>
          
          <div class="field col-3">
            <label for="saga">Saga/Univers</label>
            <input id="saga" type="text" placeholder="Ex: Star Wars" />
          </div>
          
          <div class="field col-3">
            <label for="edition">√âdition</label>
            <select id="edition">
              <option value="Simple">Simple</option>
              <option value="Steelbook">Steelbook</option>
            </select>
          </div>
          
          <div class="field col-12">
            <label>Possession & Formats</label>
            <div class="chips">
              <label class="chip">
                <input id="owned" type="checkbox" />
                Je poss√®de
              </label>
              <label class="chip">
                <input id="fmtDVD" type="checkbox" />
                DVD
              </label>
              <label class="chip">
                <input id="fmtBR" type="checkbox" />
                Blu-ray
              </label>
              <label class="chip">
                <input id="fmt4K" type="checkbox" />
                4K
              </label>
            </div>
          </div>
          
          <div class="field col-3">
            <button class="btn btn-primary" type="submit">Ajouter</button>
          </div>
          
          <div class="field col-3">
            <button id="resetBtn" class="btn btn-secondary" type="button">Effacer</button>
          </div>
        </div>
      </form>
    </section>

    <!-- Filtres -->
    <div class="toolbar">
      <input id="searchQuery" class="search-input" type="search" placeholder="Rechercher par titre, acteur, saga..." />
      
      <select id="filterType">
        <option value="all">Tous</option>
        <option value="film">Films</option>
        <option value="serie">S√©ries</option>
      </select>
      
      <select id="filterFormat">
        <option value="any">Format : Tous</option>
        <option value="DVD">DVD</option>
        <option value="Blu-ray">Blu-ray</option>
        <option value="4K">4K</option>
      </select>
      
      <select id="filterEdition">
        <option value="any">√âdition : Toutes</option>
        <option value="Simple">Simple</option>
        <option value="Steelbook">Steelbook</option>
      </select>
      
      <label class="chip">
        <input id="onlyOwned" type="checkbox" />
        Poss√©d√©s uniquement
      </label>
      
      <button id="exportBtn" class="btn btn-ghost">Exporter</button>
      <button id="importBtn" class="btn btn-ghost">Importer</button>
    </div>

    <!-- Listes -->
    <div id="loading" class="loading">Chargement...</div>
    
    <section id="ownedSection" class="section" style="display: none;">
      <h2>üìÄ Ma Collection</h2>
      <div id="ownedList" class="grid"></div>
    </section>
    
    <section id="wishSection" class="section" style="display: none;">
      <h2>‚≠ê Liste de Souhaits</h2>
      <div id="wishList" class="grid"></div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p class="footer-text">
        üí° <strong>Astuce :</strong> Remplissez le champ "Saga/Univers" pour regrouper les suites. 
        Recherche automatique des jaquettes et acteurs via TMDB. 
        Multi-√©dition temps r√©el gr√¢ce √† Firebase Firestore.
      </p>
    </div>
  </footer>

  <!-- Toast container -->
  <div id="toastContainer"></div>


<script type="module">
/* -------------------- IMPORTS FIREBASE (modules) -------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  onSnapshot,
  updateDoc,
  doc,
  serverTimestamp,
  query as fsQuery,
  orderBy,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

/* -------------------- CONFIGURATION (REMPLIS ICI) -------------------- */
const firebaseConfig = {
   apiKey: "AIzaSyBUHv_Tk3aDu0uH6wRuWxEkvD853o8HQpI",
   authDomain: "opticine-library.firebaseapp.com",
   projectId: "opticine-library",
   storageBucket: "opticine-library.firebasestorage.app",
   messagingSenderId: "363614655103",
   appId: "1:363614655103:web:a53c68539ca98f6065e54a"
};

// Cl√© TMDB
const TMDB_KEY = "124bdc1601294994a241722466e53891";
const TMDB_BASE = 'https://api.themoviedb.org/3';
const TMDB_IMG = (p) => p ? `https://image.tmdb.org/t/p/w500${p}` : '';

/* -------------------- INIT FIREBASE & AUTH ANONYME -------------------- */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

let currentUserUid = null;

signInAnonymously(auth)
  .then(() => console.log("Firebase: connexion anonyme en cours..."))
  .catch(err => console.error("Firebase Auth (signInAnonymously) erreur :", err));

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUserUid = user.uid;
    console.log("Auth OK ‚Äî uid:", currentUserUid);
  } else {
    currentUserUid = null;
    console.log("Utilisateur d√©connect√©");
  }
});

/* -------------------- SELECTEURS -------------------- */
const $ = sel => document.querySelector(sel);
const byId = id => document.getElementById(id);

const el = {
  form: byId('addForm'),
  type: byId('type'),
  title: byId('title'),
  year: byId('year'),
  posterUrl: byId('posterUrl'),
  saga: byId('saga'),
  edition: byId('edition'),
  ownedCheckbox: byId('owned'),
  fmtDVD: byId('fmtDVD'),
  fmtBR: byId('fmtBR'),
  fmt4K: byId('fmt4K'),
  acList: byId('ac-list'),
  ownedList: byId('ownedList'),
  wishList: byId('wishList'),
  mainList: byId('list'), // fallback √©ventuel
  loading: byId('loading'),
  ownedSection: byId('ownedSection'),
  wishSection: byId('wishSection'),
  resetBtn: byId('resetBtn'),
};

/* -------------------- HELPERS -------------------- */
const debounce = (fn, wait) => {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), wait);
  };
};

function elText(field, fallback = '-') {
  if (!field) return fallback;
  if (Array.isArray(field)) return field.join(', ');
  return String(field);
}

/* -------------------- TMDB: recherche & d√©tails -------------------- */
async function tmdbSearch(queryStr, kind = 'movie') {
  try {
    if (!TMDB_KEY) return [];
    const type = (kind === 'serie' || kind === 'tv') ? 'tv' : 'movie';
    const url = `${TMDB_BASE}/search/${type}?api_key=${TMDB_KEY}&language=fr-FR&query=${encodeURIComponent(queryStr)}&include_adult=false`;
    const res = await fetch(url);
    if (!res.ok) return [];
    const json = await res.json();
    return json.results || [];
  } catch (e) {
    console.error('TMDB search error', e);
    return [];
  }
}

async function tmdbGetDetails(id, kind = 'movie') {
  try {
    if (!TMDB_KEY) return null;
    const type = (kind === 'serie' || kind === 'tv') ? 'tv' : 'movie';
    const url = `${TMDB_BASE}/${type}/${id}?api_key=${TMDB_KEY}&language=fr-FR&append_to_response=credits`;
    const res = await fetch(url);
    if (!res.ok) return null;
    return await res.json();
  } catch (e) {
    console.error('TMDB details error', e);
    return null;
  }
}

function tmdbPosterPath(p) {
  return p ? TMDB_IMG(p) : '';
}

/* -------------------- RENDU ITEMS -------------------- */
function makeCard(item) {
  const container = document.createElement('article');
  container.className = 'card item-card';

  const img = document.createElement('img');
  img.className = 'poster';
  img.alt = item.title || 'Poster';
  img.src = item.posterUrl || `https://via.placeholder.com/480x720.png?text=${encodeURIComponent(item.title||'Poster')}`;
  container.appendChild(img);

  const content = document.createElement('div');
  content.className = 'card-content';

  const title = document.createElement('div');
  title.className = 'card-title';
  title.textContent = item.title || 'Sans titre';
  content.appendChild(title);

  const meta = document.createElement('div');
  meta.className = 'card-meta';
  meta.innerHTML = `
    <span>${item.type || ''}</span>
    ${item.year ? `<span>‚Ä¢ ${item.year}</span>` : ''}
    ${item.saga ? `<span>‚Ä¢ ${item.saga}</span>` : ''}
    ${item.seasonNumber ? `<span>‚Ä¢ Saison ${item.seasonNumber}</span>` : ''}
  `;
  content.appendChild(meta);

  const badges = document.createElement('div');
  badges.className = 'badges';
  (item.formats || []).forEach(f => {
    const b = document.createElement('span');
    b.className = 'badge';
    b.textContent = f;
    badges.appendChild(b);
  });
  const ed = document.createElement('span');
  ed.className = 'badge';
  ed.textContent = item.edition || 'Simple';
  badges.appendChild(ed);
  content.appendChild(badges);

  if (item.actors && item.actors.length) {
    const a = document.createElement('div');
    a.className = 'card-meta';
    a.textContent = `Acteurs: ${Array.isArray(item.actors) ? item.actors.slice(0,5).join(', ') : item.actors}`;
    content.appendChild(a);
  }

  const row = document.createElement('div');
  row.className = 'card-actions';
  const left = document.createElement('div');
  left.className = 'card-actions-left';

  // Poss√©d√©
  const ownedLabel = document.createElement('label');
  ownedLabel.className = 'chip';
  const ownedInput = document.createElement('input');
  ownedInput.type = 'checkbox';
  ownedInput.checked = !!item.obtained;
  ownedLabel.appendChild(ownedInput);
  ownedLabel.appendChild(document.createTextNode(' Poss√©d√©'));
  ownedInput.addEventListener('change', async () => {
    try {
      await updateItem(item._id, { obtained: ownedInput.checked });
    } catch (e) {
      console.error('Erreur mise √† jour obtained:', e);
      alert('Erreur mise √† jour');
      ownedInput.checked = !ownedInput.checked;
    }
  });
  left.appendChild(ownedLabel);

  // Formats
  ['DVD','Blu-ray','4K'].forEach(fmt => {
    const lb = document.createElement('label');
    lb.className = 'chip';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = (item.formats || []).includes(fmt);
    cb.addEventListener('change', async () => {
      try {
        const formats = new Set(item.formats || []);
        if (cb.checked) formats.add(fmt); else formats.delete(fmt);
        await updateItem(item._id, { formats: Array.from(formats) });
      } catch (e) {
        console.error('Erreur format toggle', e);
        alert('Erreur modification format');
        cb.checked = !cb.checked;
      }
    });
    lb.appendChild(cb);
    lb.appendChild(document.createTextNode(' ' + fmt));
    left.appendChild(lb);
  });

  row.appendChild(left);

  // Supprimer
  const delBtn = document.createElement('button');
  delBtn.className = 'btn btn-destructive';
  delBtn.textContent = 'Supprimer';
  delBtn.addEventListener('click', async () => {
    if (!confirm(`Supprimer ¬´ ${item.title} ¬ª ?`)) return;
    try {
      await deleteItem(item._id);
    } catch (e) {
      console.error('Erreur suppression', e);
      alert('Erreur suppression');
    }
  });
  row.appendChild(delBtn);

  content.appendChild(row);

  container.appendChild(content);
  return container;
}

function clearLists() {
  if (el.ownedList) el.ownedList.innerHTML = '';
  if (el.wishList) el.wishList.innerHTML = '';
  if (el.mainList) el.mainList.innerHTML = '';
}

/* -------------------- FIRESTORE CRUD -------------------- */
async function addItemToFirestore(item) {
  const docRef = await addDoc(collection(db, "library"), {
    ...item,
    createdAt: serverTimestamp(),
    createdBy: currentUserUid || null,
  });
  return docRef.id;
}

async function updateItem(docId, patch) {
  if (!docId) throw new Error('ID manquant');
  const docRef = doc(db, "library", docId);
  await updateDoc(docRef, patch);
}

async function deleteItem(docId) {
  if (!docId) throw new Error('ID manquant');
  await deleteDoc(doc(db, "library", docId));
}

/* -------------------- REAL-TIME SYNC -------------------- */
function startRealtimeListener() {
  try {
    const q = fsQuery(collection(db, "library"), orderBy('createdAt', 'desc'));
    onSnapshot(q, (snapshot) => {
      const items = [];
      snapshot.forEach(d => {
        const data = d.data();
        data._id = d.id;
        if (data.obtained === undefined && data.owned !== undefined) data.obtained = data.owned;
        if (!Array.isArray(data.formats)) data.formats = data.formats ? [data.formats] : [];
        items.push(data);
      });
      if (el.loading) el.loading.style.display = 'none';
      renderItems(items);
    }, (err) => {
      console.error('onSnapshot error', err);
      if (el.loading) el.loading.textContent = 'Erreur de chargement.';
    });
  } catch (e) {
    console.error('Erreur startRealtimeListener', e);
    if (el.loading) el.loading.textContent = 'Erreur de synchronisation.';
  }
}

/* -------------------- RENDER ALL ITEMS -------------------- */
function renderItems(items) {
  clearLists();
  const obtained = items.filter(i => !!i.obtained);
  const wish = items.filter(i => !i.obtained);

  const renderTo = (containerEl, arr) => {
    if (!containerEl) {
      if (el.mainList) containerEl = el.mainList; else return;
    }
    containerEl.innerHTML = '';
    if (arr.length === 0) {
      const p = document.createElement('p');
      p.style.opacity = '0.6';
      p.textContent = 'Aucun √©l√©ment.';
      containerEl.appendChild(p);
      return;
    }
    for (const it of arr) {
      const node = makeCard(it);
      containerEl.appendChild(node);
    }
  };

  renderTo(el.ownedList || el.mainList, obtained);
  renderTo(el.wishList || el.mainList, wish);

  if (el.ownedSection) el.ownedSection.style.display = obtained.length ? 'block' : 'none';
  if (el.wishSection) el.wishSection.style.display = wish.length ? 'block' : 'none';
}

/* -------------------- FORM: ajout -------------------- */
if (el.form) {
  el.form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    try {
      const item = {
        type: (el.type && el.type.value) ? el.type.value : 'film',
        title: el.title && el.title.value ? el.title.value.trim() : '',
        year: el.year && el.year.value ? el.year.value.trim() : '',
        posterUrl: el.posterUrl && el.posterUrl.value ? el.posterUrl.value.trim() : '',
        saga: el.saga && el.saga.value ? el.saga.value.trim() : '',
        edition: el.edition && el.edition.value ? el.edition.value : 'Simple',
        obtained: el.ownedCheckbox ? !!el.ownedCheckbox.checked : false,
        formats: [],
        actors: Array.isArray(el.form._selectedCast) ? el.form._selectedCast : []
      };

      if (el.fmtDVD && el.fmtDVD.checked) item.formats.push('DVD');
      if (el.fmtBR && el.fmtBR.checked) item.formats.push('Blu-ray');
      if (el.fmt4K && el.fmt4K.checked) item.formats.push('4K');

      // Compl√©ter via TMDB si poster manquant
      if ((!item.posterUrl || item.posterUrl.length < 5) && TMDB_KEY) {
        const kind = item.type === 'serie' ? 'tv' : 'movie';
        const results = await tmdbSearch(item.title, kind);
        if (results && results.length > 0) {
          const best = results[0];
          const det = await tmdbGetDetails(best.id, kind);
          if (det) {
            item.posterUrl = tmdbPosterPath(det.poster_path) || item.posterUrl;
            item.year = item.year || (det.release_date || det.first_air_date || '').slice(0,4);
            item.actors = item.actors.length ? item.actors : (det.credits?.cast?.slice(0,8).map(c => c.name) || []);
            if (det.belongs_to_collection?.name) {
              item.saga = item.saga || det.belongs_to_collection.name;
            }
          }
        }
      }

      await addItemToFirestore(item);
      try { el.form.reset(); } catch(e){}
      // Effacer s√©lection d'acteurs apr√®s ajout
      el.form._selectedCast = [];
      if (el.title) el.title.focus();
    } catch (err) {
      console.error('Erreur ajout item:', err);
      alert('Erreur lors de l\'ajout. Regarde la console pour plus de d√©tails.');
    }
  });
}

/* -------------------- AUTO-COMPLETE sur champ Titre -------------------- */
if (el.title && el.acList) {
  const onType = debounce(async () => {
    const q = (el.title.value || '').trim();
    el.acList.innerHTML = '';
    if (q.length < 2) { el.acList.style.display = 'none'; return; }
    try {
      const kindSel = el.type && el.type.value === 'serie' ? 'tv' : 'movie';
      const results = await tmdbSearch(q, kindSel);
      if (!results || !results.length) { el.acList.style.display = 'none'; return; }
      const slice = results.slice(0, 8);
      for (const r of slice) {
        const div = document.createElement('div');
        div.className = 'ac-item';
        div.tabIndex = 0;
        const name = r.title || r.name || 'Sans titre';
        const year = (r.release_date || r.first_air_date || '').slice(0,4) || '‚Äî';
        div.innerHTML = `
          <img src="${tmdbPosterPath(r.poster_path) || 'https://via.placeholder.com/68x102?text=‚Ä¶'}" alt="">
          <div class="ac-item-info">
            <span class="ac-item-title">${name}</span>
            <span class="ac-item-year">${year}</span>
          </div>
        `;
        div.dataset.tmdbId = r.id;
        div.dataset.mediaType = (r.media_type || (r.title ? 'movie' : 'tv'));

        div.addEventListener('click', async () => {
          try {
            const id = div.dataset.tmdbId;
            const kind = div.dataset.mediaType;
            const det = await tmdbGetDetails(id, kind === 'tv' ? 'tv' : 'movie');
            if (!det) return;
            if (el.title) el.title.value = det.title || det.name || '';
            if (el.year) el.year.value = (det.release_date || det.first_air_date || '').slice(0,4) || '';
            if (el.posterUrl) el.posterUrl.value = tmdbPosterPath(det.poster_path) || '';
            if (el.saga && det.belongs_to_collection?.name) el.saga.value = det.belongs_to_collection.name;
            if (el.form) el.form._selectedCast = det.credits?.cast?.map(c => c.name) || [];
            el.acList.style.display = 'none';
            if (el.title) el.title.focus();
          } catch (e) {
            console.error('Erreur d√©tail TMDB', e);
          }
        });

        el.acList.appendChild(div);
      }
      el.acList.style.display = 'block';
    } catch (e) {
      console.error('Autocompl√©tion TMDB erreur', e);
      el.acList.style.display = 'none';
    }
  }, 250);

  el.title.addEventListener('input', onType);
  document.addEventListener('click', (ev) => {
    if (!el.acList.contains(ev.target) && ev.target !== el.title) el.acList.style.display = 'none';
  });
}

/* -------------------- Bouton Effacer -------------------- */
if (el.resetBtn && el.form) {
  el.resetBtn.addEventListener('click', () => {
    el.form.reset();
    el.form._selectedCast = [];
    if (el.acList) { el.acList.innerHTML = ''; el.acList.style.display = 'none'; }
    if (el.title) el.title.focus();
  });
}

/* -------------------- INITIAL LOAD -------------------- */
startRealtimeListener();

</script>


</body>
</html>
